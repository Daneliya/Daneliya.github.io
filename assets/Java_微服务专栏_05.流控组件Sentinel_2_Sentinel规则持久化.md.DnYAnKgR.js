import{_ as s,c as a,o as e,aN as p}from"./chunks/framework.CMIDsdwV.js";const b=JSON.parse('{"title":"2_Sentinel规则持久化","description":"","frontmatter":{},"headers":[],"relativePath":"Java/微服务专栏/05.流控组件Sentinel/2_Sentinel规则持久化.md","filePath":"Java/微服务专栏/05.流控组件Sentinel/2_Sentinel规则持久化.md","lastUpdated":1770197784000}'),l={name:"Java/微服务专栏/05.流控组件Sentinel/2_Sentinel规则持久化.md"};function i(t,n,r,c,o,u){return e(),a("div",null,[...n[0]||(n[0]=[p(`<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /Java\\微服务专栏\\05.流控组件Sentinel\\2_Sentinel规则持久化.md for this page in Markdown format</div><h1 id="_2-sentinel规则持久化" tabindex="-1">2_Sentinel规则持久化 <a class="header-anchor" href="#_2-sentinel规则持久化" aria-label="Permalink to &quot;2_Sentinel规则持久化&quot;">​</a></h1><p>在微服务架构中，<strong>Sentinel</strong> 常用于流量控制、熔断降级等场景。默认规则存储在内存中，服务重启会丢失，因此需要将规则或监控数据<strong>持久化到数据库</strong>（如 MySQL）以保证可恢复性和可管理性。</p><p>方法一：基于Spring Data JPA持久化规则</p><p><strong>步骤：</strong></p><p><strong>创建数据库表</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>CREATE TABLE sentinel_rules (</span></span>
<span class="line"><span>   id INT AUTO_INCREMENT PRIMARY KEY,</span></span>
<span class="line"><span>   resource VARCHAR(255) NOT NULL,</span></span>
<span class="line"><span>   strategy INT NOT NULL,</span></span>
<span class="line"><span>   limit_qps DOUBLE NOT NULL,</span></span>
<span class="line"><span>   count INT NOT NULL,</span></span>
<span class="line"><span>   duration INT NOT NULL</span></span>
<span class="line"><span>);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>引入依赖</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>&lt;dependency&gt;</span></span>
<span class="line"><span>   &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span></span>
<span class="line"><span>   &lt;artifactId&gt;spring-cloud-starter-alibaba-sentinel&lt;/artifactId&gt;</span></span>
<span class="line"><span>&lt;/dependency&gt;</span></span>
<span class="line"><span>&lt;dependency&gt;</span></span>
<span class="line"><span>   &lt;groupId&gt;mysql&lt;/groupId&gt;</span></span>
<span class="line"><span>   &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span></span>
<span class="line"><span>&lt;/dependency&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><strong>配置数据库连接</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>spring.datasource.url=jdbc:mysql://localhost:3306/your_db?useUnicode=true&amp;characterEncoding=utf8</span></span>
<span class="line"><span>spring.datasource.username=root</span></span>
<span class="line"><span>spring.datasource.password=your_password</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><strong>实现持久化代码</strong></p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>@Entity</span></span>
<span class="line"><span>@Table(name=&quot;sentinel_rules&quot;)</span></span>
<span class="line"><span>public class SentinelRule {</span></span>
<span class="line"><span>   @Id @GeneratedValue(strategy=GenerationType.IDENTITY)</span></span>
<span class="line"><span>   private Long id;</span></span>
<span class="line"><span>   private String resource;</span></span>
<span class="line"><span>   private int strategy;</span></span>
<span class="line"><span>   private double limitQps;</span></span>
<span class="line"><span>   private int count;</span></span>
<span class="line"><span>   private int duration;</span></span>
<span class="line"><span>}</span></span>
<span class="line"><span>public interface SentinelRuleRepository extends JpaRepository&lt;SentinelRule, Long&gt; {}</span></span>
<span class="line"><span>@Service</span></span>
<span class="line"><span>public class SentinelRuleService {</span></span>
<span class="line"><span>   @Autowired private SentinelRuleRepository repo;</span></span>
<span class="line"><span>   public void addRule(SentinelRule rule){ repo.save(rule); }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>方法二：通过SPI扩展持久化监控数据</p><p><strong>步骤：</strong></p><p><strong>实现 *MetricFetcher* 接口</strong>，在 <em>fetch()</em> 方法中获取指标并写入数据库。<strong>注册SPI文件</strong>：在 <em>META-INF/services/com.alibaba.csp.sentinel.spi.MetricFetcher</em> 中写入实现类全名。<strong>异步写入</strong>：建议结合线程池或消息队列，避免阻塞Sentinel核心线程。</p><p>验证与优化</p><p>启动应用后，通过调用 <em>SentinelRuleService</em> 添加规则，并在数据库中确认数据是否写入。对于高频监控数据，建议批量插入或使用时序数据库（如InfluxDB）提升性能。</p><p>这样即可实现<strong>Sentinel规则与监控数据的持久化</strong>，保证系统在重启或故障后快速恢复配置。</p><p><a href="https://blog.51cto.com/u_16175446/12954218" target="_blank" rel="noreferrer">Sentinel 规则数据持久化Mysql_mob649e81576de1的技术博客_51CTO博客</a></p><p><a href="https://ask.csdn.net/questions/8641779" target="_blank" rel="noreferrer">如何将Sentinel监控数据持久化存储至数据库？_编程语言-CSDN问答</a></p>`,21)])])}const m=s(l,[["render",i]]);export{b as __pageData,m as default};
