import{_ as n,c as e,o as i,aN as p}from"./chunks/framework.CMIDsdwV.js";const l="/assets/v2-deada13263aaf9b4e16dc560fd0ccebb_1440w.BXZKbVY2.jpg",r="/assets/NuWNujC70caqIZJ3.DCt4hvcR.webp",t="/assets/44cqjd2s4a.C5gH5RaV.png",o="/assets/image-20260112000054521.81lhUkpJ.png",h="/assets/5eEKvykqyE3xgYIf.D94dTwFm.webp",c="/assets/0zPxGctwUDWS9dfZ.Ciy40WY-.webp",d="/assets/j8uhh1E1QxHUmcGp.C9BMgPZE.webp",u="/assets/SdIqvYk3d221mbHL.DQevCq1i.webp",m="/assets/image-20260112001005602.C043tLaC.png",b="/assets/image-20260112001611898.BRMhXd9X.png",k="/assets/image-20260112001546161.InCplTW4.png",s="/assets/640.BE-3mZVN.png",g="/assets/640-1694531771945.CYXAtjY_.png",x=JSON.parse('{"title":"Prometheus监控","description":"","frontmatter":{"title":"Prometheus监控","permalink":"/java/framework/distributed/prometheus","tags":["分布式监控","Prometheus"],"categories":["分布式监控","Prometheus"]},"headers":[],"relativePath":"Java/架构设计/分布式/06.分布式监控/2_Prometheus.md","filePath":"Java/架构设计/分布式/06.分布式监控/2_Prometheus.md","lastUpdated":1768149219000}'),E={name:"Java/架构设计/分布式/06.分布式监控/2_Prometheus.md"};function y(f,a,_,v,q,P){return i(),e("div",null,[...a[0]||(a[0]=[p('<div style="display:none;" hidden="true" aria-hidden="true">Are you an LLM? You can read better optimized documentation at /Java\\架构设计\\分布式\\06.分布式监控\\2_Prometheus.md for this page in Markdown format</div><h1 id="prometheus" tabindex="-1">Prometheus <a class="header-anchor" href="#prometheus" aria-label="Permalink to &quot;Prometheus&quot;">​</a></h1><h2 id="一、前言" tabindex="-1">一、前言 <a class="header-anchor" href="#一、前言" aria-label="Permalink to &quot;一、前言&quot;">​</a></h2><p>ARMS‍ 可以实现系统级的监控，这种方式简单高效，适合‌快速获得全面的监控能力。但 ARMS 主要关‍注通用的系统指标，如果我们想监控业务特有的指‍标，比如大模型的 Token 使用量、用户的‍活跃度等，就需要自定义的监控方案。</p><p>回到最初的几个核心问题，都需要我们自己来考虑了：</p><ol><li>统计什么？监控 AI 模型调用相关的业务指标</li><li>如何收集？通过在代码中埋点的方式主动收集数据。</li><li>如何存储？使用 Prometheus 时序数据库存储指标数据。</li><li>如何展示？通过 Grafana 构建可视化监控仪表板。</li></ol><p>下面我们进入方案设计阶段，依次对这几个问题进行展开。</p><h3 id="监控指标设计" tabindex="-1">监控指标设计 <a class="header-anchor" href="#监控指标设计" aria-label="Permalink to &quot;监控指标设计&quot;">​</a></h3><p>首先我们需要明确要监控哪些维度和业务指标。根据 <a href="https://docs.langchain4j.dev/tutorials/observability" target="_blank" rel="noreferrer">LangChain4j 可观测性文档</a>，我们可以获取到以下数据：</p><h4 id="维度" tabindex="-1">维度 <a class="header-anchor" href="#维度" aria-label="Permalink to &quot;维度&quot;">​</a></h4><ul><li>用户 ID</li><li>应用 ID</li><li>模型名称</li><li>最大输出 Token 数（maxOutputTokens）</li><li>AI 回复消息内容</li><li>模型生成停止的原因（Finish Reason）</li><li>调用状态（成功或失败）</li><li>请求时间</li><li>调用失败时的错误信息</li></ul><h4 id="指标" tabindex="-1">指标 <a class="header-anchor" href="#指标" aria-label="Permalink to &quot;指标&quot;">​</a></h4><ul><li>输入 Token 数量</li><li>输出 Token 数量</li><li>总消耗 Token 数量</li><li>响应时长</li></ul><h4 id="分析能力" tabindex="-1">分析能力 <a class="header-anchor" href="#分析能力" aria-label="Permalink to &quot;分析能力&quot;">​</a></h4><p>有了上面这些数据，我们能够进行很多分析：</p><ul><li>模型调用分析：统计不同时间窗口（分钟/小时/天）内各模型、用户、应用的调用次数趋势</li><li>模型性能分析：分析各模型的平均响应时间，以及响应时间分布的 P50/P90/P95/P99 百分位数</li><li>Token 消耗分析：监控不同时间窗口（分钟/小时/天）内输入 Token、输出 Token、总 Token 的消耗</li><li>热门应用排行：按调用次数对应用进行排序，识别调用 AI 最频繁的应用</li><li>用户活跃排行：按调用次数对用户进行排序，识别调用 AI 最频繁的用户</li><li>应用 Token 消耗排行：按 Token 消耗量对应用进行排序，识别消耗最高的应用</li><li>用户 Token 消耗排行：按 Token 消耗量用户进行排序，识别消耗最高的用户</li><li>错误分析：统计各模型的失败次数，以及不同错误类型的分布占比</li></ul><h3 id="数据收集方式" tabindex="-1">数据收集方式 <a class="header-anchor" href="#数据收集方式" aria-label="Permalink to &quot;数据收集方式&quot;">​</a></h3><p>在业务监控‍中，数据收集需要开‌发者手动埋点，因为‍只有业务开发者才知‍道要收集什么信息、‍从哪里收集、什么时候收集。</p><p>跟业界主流的可观测性实现方案一样，我们的策略是在业务层收集 <strong>最原始、最细粒度</strong> 的数据，这样在查询层就能进行灵活的聚合分析。</p><h2 id="二、数据存储方案-prometheus" tabindex="-1">二、数据存储方案 - Prometheus <a class="header-anchor" href="#二、数据存储方案-prometheus" aria-label="Permalink to &quot;二、数据存储方案 - Prometheus&quot;">​</a></h2><blockquote><p>官网：<a href="https://prometheus.io/" target="_blank" rel="noreferrer">Prometheus - Monitoring system &amp; time series database</a></p><p>源码：<a href="https://github.com/prometheus/prometheus" target="_blank" rel="noreferrer">https://github.com/prometheus/prometheus</a></p></blockquote><p>即使没有学‍过 Prometh‌eus，也应该知道‍可以通过数据库存储‍的方式实现监控统计‍。</p><p>比如将监控数据存储到‍ MySQL 等关系型数据库中（或者 ‌Elasticsearch），之后从数‍据库中读取。适合需要持久化保存详细数据‍的场景，而且比较灵活，可以自己写 SQ‍L 实现复杂的查询和关联分析。</p><p>但缺点是收‍集监控数据可能会比‌较频繁，需要频繁写‍入数据库，容易对应‍用性能产生影响。</p><p>因此，专业的事情交给专业的中间件来做吧！</p><h3 id="什么是-prometheus" tabindex="-1">什么是 Prometheus？ <a class="header-anchor" href="#什么是-prometheus" aria-label="Permalink to &quot;什么是 Prometheus？&quot;">​</a></h3><p><a href="https://prometheus.io/docs/introduction/overview/" target="_blank" rel="noreferrer">Prometheus</a> 是一个开源的服务监控系统和时间序列数据库，专门为时序数据的收集、存储和查询而设计。</p><p>Prometheus 的核心理念是将所有监控数据以 <strong>时间序列</strong> 的形式存储。根据它的 <a href="https://prometheus.io/docs/concepts/data_model/" target="_blank" rel="noreferrer">数据模型</a>，每个时间序列都由指标名称和一组标签唯一标识。比如 <code>http_requests_total{method=&quot;POST&quot;, handler=&quot;/api/xxl/ai&quot;}</code> 就表示一个记录 POST 请求接口总数的时间序列。</p><p>这样一来，Pr‍ometheus 能够高效地‌处理监控场景中的时间范围查询‍，比如过去一小时内各个接口的‍平均响应时间、CPU 使用率‍超过 80% 的服务器列表等。</p><p>特性：</p><ul><li>高维度数据模型</li><li>自定义查询语言</li><li>可视化数据展示</li><li>高效的存储策略</li><li>易于运维</li><li>提供各种客户端开发库</li><li>警告和报警</li><li>数据导出</li></ul><h3 id="核心组件架构" tabindex="-1">核心组件架构 <a class="header-anchor" href="#核心组件架构" aria-label="Permalink to &quot;核心组件架构&quot;">​</a></h3><p>Prometheus 包含几个关键组件，职责明确：</p><p>1）<strong>Prometheus Server（核心引擎）</strong>：整个系统的核心，负责数据收集、存储和查询。它定期从配置的目标 <strong>拉取</strong> 指标数据，将数据存储在本地的时序数据库中，并提供 PromQL 查询语言来支持复杂的数据分析。</p><ul><li><strong>数据抓取</strong>：定期从配置的 Targets 或 Exporters 拉取 <em>/metrics</em> 数据。</li><li><strong>存储</strong>：将时序数据写入内置 TSDB（按 2 小时 block 存储，支持 WAL）。</li><li><strong>查询</strong>：内置 PromQL 引擎，支持复杂聚合与分析。</li><li><strong>告警</strong>：基于 PromQL 规则触发告警并推送至 Alertmanager。</li></ul><p>2）<strong>Exporter（指标采集器）</strong>：翻译‍器，将第三方系统（如数据库、操作系统、消息队列等）‌的指标转换为 Prometheus 格式。比如 N‍ode Exporter 可以收集 Linux 系‍统的 CPU、内存、磁盘等指标，MySQL Exp‍orter 可以收集数据库的性能指标。</p><ul><li><strong>节点级</strong>：Node Exporter（CPU、内存、磁盘等）。</li><li><strong>数据库</strong>：MySQL Exporter、Redis Exporter。</li><li><strong>中间件</strong>：Nginx Exporter、Kafka Exporter。</li><li><strong>黑盒探测</strong>：Blackbox Exporter（HTTP、TCP、ICMP探测）。</li></ul><p>3）<strong>Alertmanager（告警管理器）</strong> ：理告警规‌则和通知分发。当指标触发预‍设的告警条件时，它负责将告‍警信息发送给相应的人员或系‍统，支持邮件等多种通知方式。接收 Prometheus Server 推送的告警，执行<strong>去重、分组、静默、抑制</strong>，并路由到邮件、Slack、Webhook 等通知渠道。</p><p>4）<strong>Client Libraries（客户端库）</strong> ：提供各种编程语言的 SDK‌，用于在自研应用中埋点并暴露自定义指标，支持 Go、Java、Python、Ruby 等语言。</p><p>5）<strong>Pushgateway（推送网关）</strong> 适用于<strong>短生命周期任务</strong>（如 CronJob），允许任务结束前将指标 Push 到 Pushgateway，由 Server 再 Pull 获取。</p><p>6）<strong>Grafana（可选可视化）</strong> 虽然 Prometheus 自带 Web UI，但 Grafana 提供更强大的仪表盘功能，是可视化的标准选择。</p><p><img src="'+l+'" alt="img" loading="lazy"></p><h3 id="数据收集原理" tabindex="-1">数据收集原理 <a class="header-anchor" href="#数据收集原理" aria-label="Permalink to &quot;数据收集原理&quot;">​</a></h3><p>Prometheus 采用 <strong>拉取模式</strong> 来收集指标数据，而不是由项目主动推送数据，这是它的核心特征。</p><p>它会定期向配置的目标发起 HTTP 请求，从 <code>/metrics</code> 端点获取指标数据。</p><p>拉模式的好处是：</p><ul><li>简单可靠：基于标准 HTTP 协议，无需复杂的消息队列或特殊的网络配置</li><li>监控目标的发现和管理更加灵活：Prometheus 可以通过服务发现机制自动发现新的监控目标。而且将监控的控制权交给 Prometheus，可以避免目标服务的监控数据推送失败影响业务逻辑。</li></ul><p>我们可以通过 <a href="https://prometheus.io/docs/concepts/jobs_instances/" target="_blank" rel="noreferrer">Jobs 和 Instances</a> 配置需要拉取的数据任务和服务实例，当 Prometheus 抓取目标时，会自动为每个时间序列添加 <code>job</code> 和 <code>instance</code> 标签来标识数据来源。同时还会生成一些元指标，比如 <code>up</code> 指标表示目标是否可达，<code>scrape_duration_seconds</code> 记录抓取耗时，这些信息对于监控系统自身的健康检查非常有用。</p><h3 id="指标类型" tabindex="-1">指标类型 <a class="header-anchor" href="#指标类型" aria-label="Permalink to &quot;指标类型&quot;">​</a></h3><p>如果想在项目中自定义指标收集，需要先了解 Prometheus 的 4 种核心 <a href="https://prometheus.io/docs/concepts/metric_types/" target="_blank" rel="noreferrer">指标类型</a>，每种类型都针对不同的监控场景进行了优化。</p><p>1）Counter：累积计数器，只能增加或重置为零，适合统计请求总数、错误次数等单调递增的指标。在我们的 AI 监控场景中，<code>ai_model_requests_total</code> 大模型请求总数就是一个典型的 Counter 指标。</p><p>2）Gau‍ge：仪表盘类型，数‌值可以任意上下波动，‍适合记录当前状态值，‍比如内存使用量、当前‍在线用户数、队列长度等。</p><p>3）Histog‍ram：直方图类型，用于观察数据‌分布情况，比如请求响应时间的‍分布。它会自动生成多个时间序列，包括‍各个桶的计数、总和以及总数，可以‍用来计算百分位数等统计指标。</p><p>4）Summ‍ary：和 Histog‌ram 类似，但它在客户‍端预先计算百分位数，适合‍需要精确百分位数计算但对‍网络传输有要求的场景。</p><p>通过合理选‍择指标类型，我们可‌以用最小的存储开销‍获得最大的监控价值‍。</p><h3 id="存储机制" tabindex="-1">存储机制 <a class="header-anchor" href="#存储机制" aria-label="Permalink to &quot;存储机制&quot;">​</a></h3><p>提到拉模式，可能会有朋友误以为 Prometheus 不存储数据，实际上它拥有自己的高性能时间序列数据库 <a href="https://prometheus.io/docs/prometheus/latest/storage/" target="_blank" rel="noreferrer">TSDB</a>，单节点就能处理数百万个时间序列，满足大部分企业的监控需求。</p><p>新写入的数据首先存储‍在内存中，达到时间阈值（每 2 小时一‌个数据块）后批量写入磁盘，这种设计在保‍证查询性能的同时也提供了良好的写入‍吞吐量。预写日志 WAL 机制确保了数据的‍可靠性，即使系统崩溃也不会丢失数据。</p><p><img src="'+r+'" alt="img" loading="lazy"></p><h3 id="和传统方案的对比" tabindex="-1">和传统方案的对比 <a class="header-anchor" href="#和传统方案的对比" aria-label="Permalink to &quot;和传统方案的对比&quot;">​</a></h3><p>回到我们的业务监控需求‍，可以利用 Prometheus 提供的 ‌Counter 等指标类型，轻松统计 AI‍ 模型的调用次数、响应时间、Token 消‍耗等关键指标。因为只是在内存中进行简单的数‍字递增统计，所以性能比数据库高很多。</p><p>具体的对比表格：</p><table tabindex="0"><thead><tr><th>对比维度</th><th>数据库方案</th><th>Prometheus 方案</th></tr></thead><tbody><tr><td>核心用途</td><td>审计、深度分析、事后追溯</td><td>实时监控、性能分析、告警</td></tr><tr><td>数据粒度</td><td>极高：记录每个请‍求的全部细节</td><td>聚合：只记录统计值，丢失个体请求细节</td></tr><tr><td>性能‌影响</td><td>较高：每次请求都需要数据库写入</td><td>极低：只是内存‍中的原子操作</td></tr><tr><td>实时性</td><td>差：从海量数据中实时聚合计算很慢 ‍</td><td>极好：预聚合数据，查询极快</td></tr><tr><td>存储成本</td><td>非常高：与请求‍量成正比</td><td>非常低：与指标基数成正比</td></tr></tbody></table><p>因此，我们肯定‍是选择 Prometheu‌s 方案，不仅是因为它更适‍合实时监控分析的需求，而且‍它和 Grafana 也能‍轻松整合，开发成本也很低。</p><h2 id="三、数据可视化-grafana" tabindex="-1">三、数据可视化 - Grafana <a class="header-anchor" href="#三、数据可视化-grafana" aria-label="Permalink to &quot;三、数据可视化 - Grafana&quot;">​</a></h2><h3 id="什么是-grafana" tabindex="-1">什么是 Grafana？ <a class="header-anchor" href="#什么是-grafana" aria-label="Permalink to &quot;什么是 Grafana？&quot;">​</a></h3><p><a href="https://grafana.com/" target="_blank" rel="noreferrer">Grafana</a> 是一个开源的数据可视化平台，专门用于创建监控看板。它可以连接多种数据源（包括 Prometheus、MySQL、PostgreSQL、Elasticsearch 等），并提供丰富的图表类型和可视化选项。</p><p><img src="'+t+'" alt="img" loading="lazy"></p><p>虽然 Grafana‍ 是一个功能非常丰富的企业级产品，拥有告‌警管理、用户权限控制、插件生态、云服务集‍成等高级特性，但对于我们目前的需求来说，‍将它当作一个看板工具来使用，知道怎么创建‍看板和接入数据进行展示就足够了。</p><h2 id="四、环境准备" tabindex="-1">四、环境准备 <a class="header-anchor" href="#四、环境准备" aria-label="Permalink to &quot;四、环境准备&quot;">​</a></h2><h3 id="prometheus-安装" tabindex="-1">Prometheus 安装 <a class="header-anchor" href="#prometheus-安装" aria-label="Permalink to &quot;Prometheus 安装&quot;">​</a></h3><p>1）访问 <a href="https://prometheus.io/download/" target="_blank" rel="noreferrer">Prometheus 下载页面</a>，选择对应的操作系统和架构：</p><p><img src="'+o+`" alt="image-20260112000054521" loading="lazy"></p><p>2）下载并解压到不包含中文路径的目录。</p><p>3）查看默认配置文件 <code>prometheus.yml</code>：</p><div class="language-yaml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 全局配置</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">global</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  scrape_interval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">15s</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 全局抓取间隔，默认每15秒抓取一次</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  evaluation_interval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">15s</span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"> # 规则评估间隔</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 告警管理器配置（可选）</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">alerting</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  alertmanagers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">static_configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">targets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">          # - alertmanager:9093</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 规则文件配置</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">rule_files</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # - &quot;first_rules.yml&quot;</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # - &quot;second_rules.yml&quot;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># 抓取配置</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">scrape_configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">  # Prometheus 自身监控</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">job_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;prometheus&quot;</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    static_configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">      - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">targets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;localhost:9090&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">        labels</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          app</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;prometheus&quot;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>默认配置会‍监控 Promet‌heus 自己，这‍样我们可以先测试环境是‍否正常。</p><p>💡 <a href="https://prometheus.io/docs/prometheus/latest/getting_started/#configure-rules-for-aggregating-scraped-data-into-new-time-series" target="_blank" rel="noreferrer">Prometheus Rules</a> 是用于定义监控指标的逻辑规则，包括：</p><ul><li>记录规则：预计算复杂查询并存储为新时间序列以提升性能，而不需要每次都实时计算复杂的查询表达式。</li><li>告警规则：定义告警条件并触发通知</li></ul><p>4）启动 Prometheus：</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./prometheus</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;"> --config.file=prometheus.yml</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>启动成功后会在 9090 端口提供服务。</p><p>5）访问 <a href="http://localhost:9090/" target="_blank" rel="noreferrer">http://localhost:9090</a> 进入管理界面，建议开启本地时间（不然时间可能少 8 个小时）：</p><p><img src="`+h+'" alt="img" loading="lazy"></p><p>访问 <a href="http://localhost:9090/metrics" target="_blank" rel="noreferrer">http://localhost:9090/metrics</a> 可以看到 Prometheus 自身暴露的指标数据：</p><p><img src="'+c+'" alt="img" loading="lazy"></p><p>这就是 Prometheus 期望的指标数据格式，每个应用都需要在 <code>/metrics</code> 端点暴露类似的数据。</p><p>6）在 Prometheus 查询界面可以输入 <a href="https://prometheus.io/docs/prometheus/latest/querying/basics/" target="_blank" rel="noreferrer">PromQL 表达式</a> 查看指标：</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prometheus_target_interval_length_seconds</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>这个指标记录了 ‍Prometheus 抓取目标‌之间的实际时间间隔，比如你配置‍每 15 秒抓取一次，但实际可‍能是 14.8 秒或 15.2‍ 秒，这个指标就记录这些实际值。</p><p><img src="'+d+'" alt="img" loading="lazy"></p><p>结果中的每‍一行都是一个时间序‌列，大括号内的是标‍签（维度）。其中：</p><ul><li><code>quantile=&quot;0.01&quot;</code> 表示第 1 百分位数（最快的 1%）</li><li><code>quantile=&quot;0.5&quot;</code> 表示第 50 百分位数（中位数）</li><li><code>quantile=&quot;0.99&quot;</code> 表示第 99 百分位数（最慢的 1%）</li></ul><p>这表示 99% 的抓取都在 15.0012 秒以内完成。</p><p>还可以更精确地查询特定百分位数：</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">prometheus_target_interval_length_seconds</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">{quantile=</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">&quot;0.99&quot;</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>7）在 Gr‍aph 页签可以查看可‌视化图表，比如计算过去‍ 1 分钟内 Prom‍etheus 每秒平均‍创建的内存数据块数：</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">rate(prometheus_tsdb_head_chunks_created_total[1m]</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">)</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>如图：</p><p><img src="'+u+'" alt="img" loading="lazy"></p><h3 id="grafana-安装" tabindex="-1">Grafana 安装 <a class="header-anchor" href="#grafana-安装" aria-label="Permalink to &quot;Grafana 安装&quot;">​</a></h3><p>1）访问 <a href="https://grafana.com/grafana/download" target="_blank" rel="noreferrer">Grafana 下载页面</a>，根据操作系统选择对应的安装包：</p><p><img src="'+m+'" alt="image-20260112001005602" loading="lazy"></p><p>2）按照对应系统的 <a href="https://grafana.com/docs/grafana/latest/setup-grafana/installation/" target="_blank" rel="noreferrer">安装文档</a> 进行安装。比如 Windows 系统直接执行 <code>grafana-server.exe</code>，Mac 系统执行下列命令：</p><div class="language-sh vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">sh</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">./bin/grafana</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;"> server</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br></div></div><p>启动成功的日志信息：</p><p><img src="'+b+'" alt="image-20260112001611898" loading="lazy"></p><p>3）访问 <a href="http://localhost:3000/" target="_blank" rel="noreferrer">http://localhost:3000</a> 查看看板，默认登录账号密码都是 <code>admin</code>：</p><p><img src="'+k+`" alt="image-20260112001546161" loading="lazy"></p><p>💡 可以参考 <a href="https://grafana.com/docs/grafana/latest/getting-started/build-first-dashboard/" target="_blank" rel="noreferrer">起始文档</a> 来学习如何使用 Grafana 构造看板。</p><h3 id="grafana-整合-prometheus" tabindex="-1">Grafana 整合 Prometheus <a class="header-anchor" href="#grafana-整合-prometheus" aria-label="Permalink to &quot;Grafana 整合 Prometheus&quot;">​</a></h3><p>Grafana 与 Prometheus 打配合的 <a href="https://grafana.com/docs/grafana/latest/datasources/prometheus/" target="_blank" rel="noreferrer">工作原理</a> 很简单：Grafana 通过 HTTP API 从 Prometheus 查询数据，然后以图表形式展示。用户可以编写 PromQL 表达式来实现灵活的数据分析。</p><p>下面来跑通一下整合流程。</p><p>1）参考 <a href="https://grafana.com/docs/grafana/latest/getting-started/get-started-grafana-prometheus/" target="_blank" rel="noreferrer">官方文档</a>，登录 Grafana 后，需要先添加 Prometheus 作为数据源：</p><p>配置 Prometheus 服务器地址，然后测试连接：</p><p>💡 除了手动‍配置外，Grafana 还‌支持通过 Provisio‍ning 配置文件自动导入‍数据源和仪表板，这在自动化‍部署（或者多环境）中很有用。</p><p>2）快速导‍入现成的仪表板模板‌：</p><p>3）进入看板页面，查看导入的看板：</p><p>4）查看看‍板详情，一个仪表板‌可以包含多个 Pa‍nel（图表面板）‍：</p><p>每个 Panel 都可以查看具体的数据、状态和查询语句：</p><p>5）右上角‍可以将整个仪表板导‌出为 JSON 格‍式，便于分享和备份‍：</p><p>同样也可以通过导入 JSON 快速创建仪表板：</p><h2 id="五、springboot集成使用" tabindex="-1">五、SpringBoot集成使用 <a class="header-anchor" href="#五、springboot集成使用" aria-label="Permalink to &quot;五、SpringBoot集成使用&quot;">​</a></h2><h3 id="_1-spring-boot-工程集成-micrometer" tabindex="-1">1.Spring Boot 工程集成 Micrometer <a class="header-anchor" href="#_1-spring-boot-工程集成-micrometer" aria-label="Permalink to &quot;1.Spring Boot 工程集成 Micrometer&quot;">​</a></h3><h5 id="_1-1引入依赖" tabindex="-1">1.1引入依赖 <a class="header-anchor" href="#_1-1引入依赖" aria-label="Permalink to &quot;1.1引入依赖&quot;">​</a></h5><div class="language-xml vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">xml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;org.springframework.boot&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;spring-boot-starter-actuator&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;io.micrometer&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">groupId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">  &lt;</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;micrometer-registry-prometheus&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">artifactId</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&lt;/</span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">dependency</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt;</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><h5 id="_1-2配置" tabindex="-1">1.2配置 <a class="header-anchor" href="#_1-2配置" aria-label="Permalink to &quot;1.2配置&quot;">​</a></h5><div class="language-properties vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">properties</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">management.server.port</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=9003</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">management.endpoints.web.exposure.include</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=*</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">management.endpoint.metrics.enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">management.endpoint.health.show-details</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=always</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">management.endpoint.health.probes.enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">management.endpoint.prometheus.enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">management.metrics.export.prometheus.enabled</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=true</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">management.metrics.tags.application</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">=voice-qc-backend</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这里 <code>management.endpoints.web.exposure.include=*</code> 配置为开启 Actuator 服务，因为Spring Boot Actuator 会自动配置一个 URL 为 <code>/actuator/Prometheus</code> 的 HTTP 服务来供 Prometheus 抓取数据，不过默认该服务是关闭的，该配置将打开所有的 Actuator 服务。</p><p><code>management.metrics.tags.application</code> 配置会将该工程应用名称添加到计量器注册表的 tag 中去，方便后边 Prometheus 根据应用名称来区分不同的服务。</p><h5 id="_1-3监控jvm信息" tabindex="-1">1.3监控jvm信息 <a class="header-anchor" href="#_1-3监控jvm信息" aria-label="Permalink to &quot;1.3监控jvm信息&quot;">​</a></h5><p>然后在工程启动主类中添加 Bean 如下来监控 JVM 性能指标信息：</p><div class="language-java vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang">java</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">@</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">SpringBootApplication</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> class</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> GatewayDatumApplication</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> {</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">    public</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> static</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;"> void</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;"> main</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">String</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">[] </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">args</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        SpringApplication.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">run</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(GatewayDatumApplication.class, args);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Bean</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    MeterRegistryCustomizer&lt;</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">MeterRegistry</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">&gt; </span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">configurer</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            @</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">Value</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;\${spring.application.name}&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) String </span><span style="--shiki-light:#E36209;--shiki-dark:#FFAB70;">applicationName</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">) {</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">        return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> (registry) </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">-&gt;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> registry.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">().</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">commonTags</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;application&quot;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, applicationName);</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    }</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><h5 id="_1-4创建自定义监控" tabindex="-1">1.4创建自定义监控 <a class="header-anchor" href="#_1-4创建自定义监控" aria-label="Permalink to &quot;1.4创建自定义监控&quot;">​</a></h5><p>监控请求次数与响应时间</p><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>package com.lianxin.gobot.api.monitor;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import io.micrometer.core.instrument.Counter;</span></span>
<span class="line"><span>import io.micrometer.core.instrument.MeterRegistry;</span></span>
<span class="line"><span>import io.micrometer.core.instrument.Timer;</span></span>
<span class="line"><span>import lombok.Getter;</span></span>
<span class="line"><span>import org.springframework.beans.factory.annotation.Autowired;</span></span>
<span class="line"><span>import org.springframework.beans.factory.annotation.Value;</span></span>
<span class="line"><span>import org.springframework.stereotype.Component;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>import javax.annotation.PostConstruct;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>/**</span></span>
<span class="line"><span> * @Author: GZ</span></span>
<span class="line"><span> * @CreateTime: 2022-08-30  10:50</span></span>
<span class="line"><span> * @Description: 自定义监控服务</span></span>
<span class="line"><span> * @Version: 1.0</span></span>
<span class="line"><span> */</span></span>
<span class="line"><span>@Component</span></span>
<span class="line"><span>public class PrometheusCustomMonitor {</span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 上报拨打请求次数</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    @Getter</span></span>
<span class="line"><span>    private Counter reportDialRequestCount;</span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 上报拨打URL</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    @Value(&quot;\${lx.call-result-report.url}&quot;)</span></span>
<span class="line"><span>    private String callReportUrl;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    /**</span></span>
<span class="line"><span>     * 上报拨打响应时间</span></span>
<span class="line"><span>     */</span></span>
<span class="line"><span>    @Getter</span></span>
<span class="line"><span>    private Timer reportDialResponseTime;</span></span>
<span class="line"><span>    @Getter</span></span>
<span class="line"><span>    private final MeterRegistry registry;</span></span>
<span class="line"><span></span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @Autowired</span></span>
<span class="line"><span>    public PrometheusCustomMonitor(MeterRegistry registry) {</span></span>
<span class="line"><span>        this.registry = registry;</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    @PostConstruct</span></span>
<span class="line"><span>    private void init() {</span></span>
<span class="line"><span>        reportDialRequestCount = registry.counter(&quot;go_api_report_dial_request_count&quot;, &quot;url&quot;,callReportUrl);</span></span>
<span class="line"><span>        reportDialResponseTime=  registry.timer(&quot;go_api_report_dial_response_time&quot;, &quot;url&quot;,callReportUrl);</span></span>
<span class="line"><span>    }</span></span>
<span class="line"><span>}</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br></div></div><h5 id="_1-5添加具体业务代码监控" tabindex="-1">1.5添加具体业务代码监控 <a class="header-anchor" href="#_1-5添加具体业务代码监控" aria-label="Permalink to &quot;1.5添加具体业务代码监控&quot;">​</a></h5><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>//统计请求次数</span></span>
<span class="line"><span>prometheusCustomMonitor.getReportDialRequestCount().increment();</span></span>
<span class="line"><span>long startTime = System.currentTimeMillis();</span></span>
<span class="line"><span>String company = HttpUtils.post(companyUrl,&quot;&quot;);</span></span>
<span class="line"><span>//统计响应时间</span></span>
<span class="line"><span>long endTime = System.currentTimeMillis();</span></span>
<span class="line"><span>prometheusCustomMonitor.getReportDialResponseTime().record(endTime-startTime, TimeUnit.MILLISECONDS);</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>在浏览器访问 <code>http://127.0.0.1:9001/actuator/prometheus</code> ，就可以看到服务的一系列不同类型 metrics 信息，例如<code>jvm_memory_used_bytes gauge</code>、<code>jvm_gc_memory_promoted_bytes_total counter</code> ，<code>go_api_report_dial_request_count</code>等</p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/JfTPiahTHJhrkf2DzYicJ84YjNTO9WGE9TB4sQicDO0fhqPIyJDBFMeZfnzsc9YCGW9ricRgZMfS47A51v4jCosOTw/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片" loading="lazy"></p><p>到此，Spring Boot 工程集成 Micrometer 就已经完成，接下里就要与 Prometheus 进行集成了。</p><h3 id="_2-集成-prometheus" tabindex="-1">2.集成 Prometheus <a class="header-anchor" href="#_2-集成-prometheus" aria-label="Permalink to &quot;2.集成 Prometheus&quot;">​</a></h3><h5 id="_2-1安装" tabindex="-1">2.1安装 <a class="header-anchor" href="#_2-1安装" aria-label="Permalink to &quot;2.1安装&quot;">​</a></h5><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>docker pull prom/prometheus</span></span>
<span class="line"><span>mdkir /usr/local/prometheus</span></span>
<span class="line"><span>vi prometheus.yml</span></span>
<span class="line"><span># my global config</span></span>
<span class="line"><span>global:</span></span>
<span class="line"><span>  scrape_interval: 15s # Set the scrape interval to every 15 seconds. Default is every 1 minute.</span></span>
<span class="line"><span>  evaluation_interval: 15s # Evaluate rules every 15 seconds. The default is every 1 minute.</span></span>
<span class="line"><span>  # scrape_timeout is set to the global default (10s).</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Alertmanager configuration</span></span>
<span class="line"><span>alerting:</span></span>
<span class="line"><span>  alertmanagers:</span></span>
<span class="line"><span>  - static_configs:</span></span>
<span class="line"><span>    - targets:</span></span>
<span class="line"><span>      # - alertmanager:9093</span></span>
<span class="line"><span></span></span>
<span class="line"><span># Load rules once and periodically evaluate them according to the global &#39;evaluation_interval&#39;.</span></span>
<span class="line"><span>rule_files:</span></span>
<span class="line"><span>  # - &quot;first_rules.yml&quot;</span></span>
<span class="line"><span>  # - &quot;second_rules.yml&quot;</span></span>
<span class="line"><span></span></span>
<span class="line"><span># A scrape configuration containing exactly one endpoint to scrape:</span></span>
<span class="line"><span># Here it&#39;s Prometheus itself.</span></span>
<span class="line"><span>scrape_configs:</span></span>
<span class="line"><span>  # The job name is added as a label \`job=&lt;job_name&gt;\` to any timeseries scraped from this config.</span></span>
<span class="line"><span>  - job_name: &#39;prometheus&#39;</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    # metrics_path defaults to &#39;/metrics&#39;</span></span>
<span class="line"><span>    # scheme defaults to &#39;http&#39;.</span></span>
<span class="line"><span></span></span>
<span class="line"><span>    static_configs:</span></span>
<span class="line"><span>    - targets: [&#39;192.168.136.129:9090&#39;]</span></span>
<span class="line"><span>docker run -d --name prometheus -p 9090:9090 -v/usr/local/prometheus/prometheus.yml:/etc/prometheus/prometheus.yml prom/prometheus</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br></div></div><p><img src="`+s+`" alt="图片" loading="lazy"></p><h5 id="_2-2集成配置" tabindex="-1">2.2集成配置 <a class="header-anchor" href="#_2-2集成配置" aria-label="Permalink to &quot;2.2集成配置&quot;">​</a></h5><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>global:</span></span>
<span class="line"><span>  scrape_interval: 15s</span></span>
<span class="line"><span></span></span>
<span class="line"><span>scrape_configs:</span></span>
<span class="line"><span>  - job_name: &quot;prometheus&quot;</span></span>
<span class="line"><span>    static_configs:</span></span>
<span class="line"><span>    - targets: [&quot;localhost:9090&quot;]</span></span>
<span class="line"><span>  - job_name: &quot;metricsLocalTest&quot;</span></span>
<span class="line"><span>    metrics_path: &quot;/actuator/prometheus&quot;</span></span>
<span class="line"><span>    static_configs:</span></span>
<span class="line"><span>    - targets: [&quot;localhost:9003&quot;]</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>这里 <code>localhost:9001</code> 就是上边本地启动的服务地址，也就是 Prometheus 要监控的服务地址。同时可以添加一些与应用相关的标签，方便后期执行 PromSQL 查询语句区分。最后重启 Prometheus 服务</p><p><img src="`+s+'" alt="图片" loading="lazy"></p><p><img src="'+s+`" alt="图片" loading="lazy"></p><h3 id="_3-使用-grafana-dashboard-展示监控项" tabindex="-1">3.使用 Grafana Dashboard 展示监控项 <a class="header-anchor" href="#_3-使用-grafana-dashboard-展示监控项" aria-label="Permalink to &quot;3.使用 Grafana Dashboard 展示监控项&quot;">​</a></h3><h5 id="_3-1安装grafana" tabindex="-1">3.1安装grafana <a class="header-anchor" href="#_3-1安装grafana" aria-label="Permalink to &quot;3.1安装grafana&quot;">​</a></h5><div class="language- vp-adaptive-theme line-numbers-mode"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>docker pull grafana/grafana</span></span>
<span class="line"><span>docker run -d --name grafana -p 3000:3000 -v /usr/local/grafana:/var/lib/grafana grafana/grafana</span></span></code></pre><div class="line-numbers-wrapper" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>默认用户名/密码 admin/admin</p><p><img src="`+g+'" alt="图片" loading="lazy"></p><h5 id="_3-2配置prometheus数据源" tabindex="-1">3.2配置prometheus数据源 <a class="header-anchor" href="#_3-2配置prometheus数据源" aria-label="Permalink to &quot;3.2配置prometheus数据源&quot;">​</a></h5><p><img src="https://mmbiz.qpic.cn/mmbiz_png/JfTPiahTHJhrkf2DzYicJ84YjNTO9WGE9TrsYHAibSroeibGz7fcJtbdn9o4GzK1vQ8hSbQiacXm98k6juojWp8KJsg/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片" loading="lazy"></p><h5 id="_3-3增加jvm面板" tabindex="-1">3.3增加jvm面板 <a class="header-anchor" href="#_3-3增加jvm面板" aria-label="Permalink to &quot;3.3增加jvm面板&quot;">​</a></h5><p>模板编号为4701</p><p><img src="'+s+'" alt="图片" loading="lazy"></p><p><img src="https://mmbiz.qpic.cn/mmbiz_png/JfTPiahTHJhrkf2DzYicJ84YjNTO9WGE9T1NNuiaed5icDqURydelENgYzVicp6UjRibhlDSiaVoMscosdmiaG5CqYiaGNw/640?wx_fmt=png&amp;tp=wxpic&amp;wxfrom=5&amp;wx_lazy=1&amp;wx_co=1" alt="图片" loading="lazy"></p><h5 id="_3-4配置业务接口监控面板" tabindex="-1">3.4配置业务接口监控面板 <a class="header-anchor" href="#_3-4配置业务接口监控面板" aria-label="Permalink to &quot;3.4配置业务接口监控面板&quot;">​</a></h5><p><img src="'+s+'" alt="图片" loading="lazy"></p><h2 id="参考资料" tabindex="-1">参考资料 <a class="header-anchor" href="#参考资料" aria-label="Permalink to &quot;参考资料&quot;">​</a></h2><p>[1]. <a href="https://blog.csdn.net/GZ946/article/details/126619218" target="_blank" rel="noreferrer">springboot+Prometheus+grafana 实现自定义监控（请求数、响应时间、JVM性能）</a></p><p>[2]. <a href="https://blog.51cto.com/u_16099246/7607251" target="_blank" rel="noreferrer">https://blog.51cto.com/u_16099246/7607251</a></p>',166)])])}const D=n(E,[["render",y]]);export{x as __pageData,D as default};
